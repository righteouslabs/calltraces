# Python package
# Create and test a Python package on multiple Python versions.
# Add steps that analyze code, save the dist with the build record, publish to a PyPI-compatible index, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/python

trigger:
- main

pool:
  vmImage: ubuntu-latest

strategy:
  matrix:
    Python3.8:
      python.version: '3.8'
    Python3.9:
      python.version: '3.9'
    Python3.10:
      python.version: '3.10'

steps:

- task: UsePythonVersion@0
  inputs:
    versionSpec: $(python.version)
  displayName: ğŸ Use Python $(python.version)

- bash: echo "##vso[task.prependpath]$CONDA/bin"
  displayName: â¡ï¸ Add conda to system path

  # https://docs.microsoft.com/en-us/azure/devops/pipelines/ecosystems/anaconda
- bash: |
    # Update Conda
    conda update --name base --channel defaults conda --yes --verbose
  displayName: ğŸ Update Conda

  # https://docs.microsoft.com/en-us/azure/devops/pipelines/ecosystems/anaconda
- bash: |
    # Update Conda packages
    conda env update --file environment.yml --verbose
  displayName: â¬‡ï¸ Install dependencies

- bash: |
    # Activate conda environment
    source activate calltraces

    # Install pre-commit
    pre-commit install

    # Run pre-commit checks
    pre-commit run --all-files
  displayName: âœ”ï¸ Run pre-commit checks

- bash: |
    # Activate conda environment
    source activate calltraces

    # stop the build if there are Python syntax errors or undefined names
    flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
    # exit-zero treats all errors as warnings
    flake8 . --count --exit-zero --statistics
  displayName: ğŸ“ Lint with flake8

- bash: |
    # Activate conda environment
    source activate calltraces

    # stop the build if there are Python issues with Black
    python -m black --check .
  displayName: ğŸ“ Lint with Black

- bash: |
    # Activate conda environment
    source activate calltraces

    # stop the build if there are Python issues with Black
    pytest --doctest-modules --junitxml=junit/test-results.xml --cov=. --cov-report=xml
  displayName: ğŸ§ª Test with pytest

- task: PublishTestResults@2
  condition: succeededOrFailed()
  inputs:
    testResultsFiles: '**/test-*.xml'
    testRunTitle: 'Publish test results for Python $(python.version)'
  displayName: â« Publish test results

- task: PublishCodeCoverageResults@1
  inputs:
    codeCoverageTool: Cobertura
    summaryFileLocation: '$(System.DefaultWorkingDirectory)/**/coverage.xml'
  displayName: â« Publish coverage results
